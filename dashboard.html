<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widi Finance Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #0066FF; --bg-body: #F3F5F9; --text-dark: #1F2937; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-dark); padding-bottom: 80px; }
        .navbar { background: white; border-bottom: 1px solid #E5E7EB; padding: 15px 0; }
        .card-balance { background: linear-gradient(135deg, #0066FF 0%, #2563EB 100%); border-radius: 20px; padding: 25px; color: white; margin-bottom: 25px; }
        .asset-breakdown { background: rgba(0, 0, 0, 0.2); border-radius: 12px; padding: 15px; margin-top: 20px; font-size: 0.85rem; }
        .asset-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .card-box { background: white; border-radius: 16px; border: 1px solid #E5E7EB; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .wallet-item { background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .wallet-icon { width: 40px; height: 40px; border-radius: 10px; background: #EFF6FF; color: var(--primary); display: flex; align-items: center; justify-content: center; }
        .trx-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #F3F4F6; }
        .trx-icon-box { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; }
        .progress-cicilan { background-color: #E5E7EB; } .progress-bar-cicilan { background-color: #DC2626; } 
        .bg-inc { background: #DCFCE7; color: #16A34A; } .bg-exp { background: #FEE2E2; color: #DC2626; } .bg-trf { background: #E0F2FE; color: #0284C7; }
        .btn-float { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 24px; border: none; display: grid; place-items: center; z-index: 999; }
        .month-nav { display: flex; align-items: center; gap: 8px; background: #F3F4F6; padding: 4px 8px; border-radius: 20px; }
        .btn-nav { width: 28px; height: 28px; border-radius: 50%; border: none; background: white; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <nav class="navbar mb-4 sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="#"><i class="fas fa-wallet me-2"></i>Widi Finance</a>
            <button class="btn btn-sm btn-light text-danger" id="btnLogout"><i class="fas fa-power-off"></i></button>
        </div>
    </nav>

    <div class="container">
        <div class="card-balance">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div><small class="opacity-75 d-block fw-semibold text-uppercase">Total Harta Bersih</small><h1 class="fw-bold mb-0" id="totalHarta">Rp 0</h1></div>
                <div class="text-end"><span class="badge bg-white bg-opacity-25" id="walletCount">...</span><small class="d-block mt-1 opacity-75" style="font-size:0.7rem;" id="userEmail">Loading...</small></div>
            </div>
            <div class="asset-breakdown"><small class="opacity-75 fw-bold mb-2 d-block text-uppercase" style="font-size: 0.7rem;">Lokasi Uang Kamu:</small><div id="detailAsetList"><small class="opacity-50">Memuat rincian...</small></div></div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card-box">
                    <div class="d-flex justify-content-between mb-3"><h6 class="fw-bold">Arus Kas</h6><span class="badge bg-primary text-white" id="chartLabel">Bulan Ini</span></div>
                    <div style="height: 250px;"><canvas id="chartArusKas"></canvas></div>
                </div>

                <div class="card-box">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold m-0">Riwayat Transaksi</h6>
                        <div class="d-flex align-items-center gap-2">
                            <div class="month-nav">
                                <button class="btn-nav" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                                <span class="small fw-bold px-1" id="monthLabel" style="min-width: 90px; text-align: center;">...</span>
                                <button class="btn-nav" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                            </div>
                            <button class="btn btn-sm btn-danger rounded-circle" style="width: 32px; height: 32px;" onclick="downloadPDF()" title="Download PDF"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn btn-sm btn-success rounded-circle" style="width: 32px; height: 32px;" onclick="downloadCSV()" title="Download CSV"><i class="fas fa-file-csv"></i></button>
                        </div>
                    </div>
                    <div id="transactionList" style="min-height: 200px;"><div class="text-center py-5"><div class="spinner-border text-primary"></div></div></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card-box bg-light border-0">
                    <div class="d-flex justify-content-between align-items-center mb-3"><h6 class="fw-bold m-0 text-primary">Dompet Saya</h6><button class="btn btn-sm btn-primary rounded-pill px-3" onclick="bukaModal('modalAddWallet')">+ Baru</button></div>
                    <div id="walletList"></div>
                </div>
                
                <div class="card-box">
                    <div class="d-flex justify-content-between align-items-center mb-3"><h6 class="fw-bold m-0">Target Tabungan</h6><button class="btn btn-sm btn-outline-primary rounded-pill" onclick="bukaModal('modalGoal')">+ Target</button></div>
                    <div id="goalList"></div>
                </div>

                <div class="card-box border-danger border-opacity-25" style="background: #FFF5F5;">
                    <div class="d-flex justify-content-between align-items-center mb-3"><h6 class="fw-bold m-0 text-danger">Cicilan & Hutang</h6><button class="btn btn-sm btn-outline-danger rounded-pill" onclick="bukaModal('modalDebt')">+ Cicilan</button></div>
                    <div id="debtList"></div>
                </div>

                <div class="card-box">
                    <h6 class="fw-bold mb-3">Aksi Cepat</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary fw-bold text-start" onclick="bukaModal('modalTransfer')"><i class="fas fa-exchange-alt me-2"></i> Transfer Saldo</button>
                        <button class="btn btn-outline-success fw-bold text-start" onclick="modeTrx('income')"><i class="fas fa-arrow-down me-2"></i> Catat Pemasukan</button>
                        <button class="btn btn-outline-danger fw-bold text-start" onclick="modeTrx('expense')"><i class="fas fa-arrow-up me-2"></i> Catat Pengeluaran</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="btn-float" onclick="bukaModal('modalTransaksi')"><i class="fas fa-plus"></i></button>

    <div class="modal fade" id="modalTransaksi" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold mb-4">Catat Transaksi</h5><div class="d-flex gap-2 mb-3"><input type="radio" class="btn-check" name="trxType" id="exp" value="expense" checked onchange="updateCat()"><label class="btn btn-outline-danger w-50" for="exp" id="lblExp">Keluar</label><input type="radio" class="btn-check" name="trxType" id="inc" value="income" onchange="updateCat()"><label class="btn btn-outline-success w-50" for="inc" id="lblInc">Masuk</label></div><div class="mb-2"><label>Dompet</label><select class="form-select" id="trxWallet"></select></div><div class="mb-2"><label>Nominal</label><input type="number" class="form-control" id="trxAmount"></div><div class="mb-2"><label>Kategori</label><select class="form-select" id="trxCategory"></select></div><div class="mb-3"><label>Catatan</label><input type="text" class="form-control" id="trxDesc" placeholder="Contoh: Beli Bensin"></div><button class="btn btn-primary w-100" onclick="simpanTransaksi()">Simpan</button></div></div></div></div>
    <div class="modal fade" id="modalAddWallet" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Kelola Dompet</h5><input type="hidden" id="editWId"><div class="mb-2"><label>Nama</label><input type="text" class="form-control" id="wName"></div><div class="mb-3"><label>Saldo</label><input type="number" class="form-control" id="wBalance"></div><button class="btn btn-primary w-100" onclick="simpanDompet()">Simpan</button></div></div></div></div>
    <div class="modal fade" id="modalTransfer" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold text-center mb-3">Transfer</h5><div class="d-flex gap-2 mb-2"><div class="w-50"><label class="small fw-bold text-danger">DARI</label><select class="form-select" id="tfFrom"></select></div><div class="w-50"><label class="small fw-bold text-success">KE</label><select class="form-select" id="tfTo"></select></div></div><div class="mb-3"><label>Nominal</label><input type="number" class="form-control text-center fw-bold" id="tfAmt"></div><button class="btn btn-dark w-100" onclick="simpanTransfer()">Kirim</button></div></div></div></div>
    <div class="modal fade" id="modalGoal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold mb-3">Kelola Target</h5><input type="hidden" id="editGId"><input type="text" class="form-control mb-2" id="gName" placeholder="Nama Barang"><input type="number" class="form-control mb-3" id="gTarget" placeholder="Harga Target"><button class="btn btn-success w-100" onclick="simpanGoal()">Simpan Target</button></div></div></div></div>
    <div class="modal fade" id="modalDebt" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><h5 class="fw-bold mb-3 text-danger">Kelola Cicilan</h5><input type="hidden" id="editDId"><input type="text" class="form-control mb-2" id="dName" placeholder="Nama Cicilan"><input type="number" class="form-control mb-3" id="dTotal" placeholder="Total Hutang"><button class="btn btn-danger w-100" onclick="simpanDebt()">Simpan</button></div></div></div></div>
    <div class="modal fade" id="modalNabung" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><h6 class="text-center mb-3">Nabung ke <span id="lblTargetName" class="text-primary fw-bold"></span></h6><input type="hidden" id="targetIdHide"><div class="mb-2"><label>Ambil Dari</label><select class="form-select" id="srcWallet"></select></div><div class="mb-3"><label>Jumlah</label><input type="number" class="form-control" id="saveAmount"></div><button class="btn btn-success w-100" onclick="prosesNabung()">Simpan</button></div></div></div></div>
    <div class="modal fade" id="modalBayarCicilan" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body p-4"><h6 class="text-center mb-3">Bayar Cicilan <span id="lblDebtName" class="text-danger fw-bold"></span></h6><input type="hidden" id="debtIdHide"><div class="mb-2"><label>Bayar Pakai</label><select class="form-select" id="srcWalletDebt"></select></div><div class="mb-3"><label>Nominal Bayar</label><input type="number" class="form-control" id="payDebtAmount"></div><button class="btn btn-danger w-100" onclick="prosesBayarCicilan()">Bayar Sekarang</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const supabaseUrl = 'https://zzloutsqmpkifzijxaip.supabase.co';
        const supabaseKey = 'sb_publishable_uJHTWglP11uZzp3dKK7bdA_sY9xtmXv';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        let currentUser=null, myWallets=[];
        let totalWallet = 0; let totalGoal = 0; let goalDetails = [];
        let viewDate = new Date(); let currentTrxData = [];
        let debtsData = []; 

        document.addEventListener("DOMContentLoaded", () => {
            _supabase.auth.onAuthStateChange((event, session) => {
                if (session) {
                    currentUser = session.user;
                    document.getElementById('userEmail').innerText = currentUser.email;
                    updateCat(); loadAll();
                } else { window.location.href = 'index.html'; }
            });
        });

        async function loadAll() {
            await Promise.all([loadWallets(), loadGoals(), loadDebts()]);
            await loadTransactions();
            const grandTotal = totalWallet + totalGoal;
            document.getElementById('totalHarta').innerText = fmt(grandTotal);
            const detailBox = document.getElementById('detailAsetList');
            let html = `<div class="asset-row"><span>ðŸ’µ Sisa di Dompet</span><span class="fw-bold">${fmt(totalWallet)}</span></div>`;
            if(goalDetails.length > 0) { goalDetails.forEach(g => { html += `<div class="asset-row"><span>ðŸŽ¯ ${g.name}</span><span class="fw-bold">${fmt(g.amount)}</span></div>`; }); } 
            else { html += `<div class="asset-row opacity-50"><span>ðŸŽ¯ Belum ada tabungan</span><span>Rp 0</span></div>`; }
            detailBox.innerHTML = html;
        }

        // --- UPDATE 1: FITUR TOTAL DI CICILAN ---
        async function loadDebts() {
            const { data } = await _supabase.from('debts').select('*').order('created_at');
            debtsData = data || [];
            const list = document.getElementById('debtList'); list.innerHTML = '';
            
            let sumTotalDebt = 0;
            let sumSisaDebt = 0;

            if(data && data.length > 0) {
                data.forEach(d => {
                    sumTotalDebt += d.total_amount;
                    const sisa = Math.max(0, d.total_amount - d.paid_amount);
                    sumSisaDebt += sisa;

                    const pct = Math.min(100, Math.round((d.paid_amount/d.total_amount)*100));
                    const isLunas = pct >= 100;
                    
                    let actionBtn = isLunas ? `<button class="btn btn-sm btn-outline-dark py-0" onclick="ulangiCicilan(${d.id}, '${d.name}')" title="Reset ke 0%"><i class="fas fa-sync-alt me-1"></i>Ulangi</button>` : `<button class="btn btn-sm btn-light text-danger py-0 fw-bold" onclick="modalBayarCicilan(${d.id},'${d.name}')">+ Bayar</button>`;

                    list.innerHTML += `<div class="mb-3 border-bottom pb-2"><div class="d-flex justify-content-between align-items-center mb-1"><span class="small fw-bold ${isLunas ? 'text-success' : 'text-danger'}">${d.name} <span class="text-dark">${pct}%</span></span><div><i class="fas fa-pencil-alt text-muted small me-2 cursor-pointer" onclick="editDebt(${d.id})"></i><i class="fas fa-trash text-muted small cursor-pointer" onclick="hapusDebt(${d.id}, '${d.name}')"></i></div></div><div class="progress mb-2 progress-cicilan" style="height:6px"><div class="progress-bar progress-bar-cicilan ${isLunas ? 'bg-success' : ''}" style="width:${pct}%"></div></div><div class="d-flex justify-content-between align-items-center"><small class="text-muted" style="font-size:0.7rem">Sisa: ${fmt(sisa)}</small>${actionBtn}</div></div>`;
                });

                // TAMBAHAN: TOTAL DI BAWAH
                list.innerHTML += `
                <div class="mt-2 pt-2 border-top d-flex justify-content-between fw-bold text-danger" style="font-size: 0.8rem;">
                    <span>Total Hutang: ${fmt(sumTotalDebt)}</span>
                    <span>Sisa: ${fmt(sumSisaDebt)}</span>
                </div>`;

            } else { list.innerHTML = '<div class="text-center text-muted small py-2">Tidak ada cicilan</div>'; }
        }

        function editDebt(id) {
            const d = debtsData.find(x => x.id == id);
            if(d) {
                document.getElementById('editDId').value = d.id;
                document.getElementById('dName').value = d.name;
                document.getElementById('dTotal').value = d.total_amount;
                bukaModal('modalDebt');
            }
        }

        async function ulangiCicilan(id, name) {
            if(confirm(`Siapkan "${name}" untuk tagihan bulan baru? Progress akan di-reset jadi 0%.`)){
                await _supabase.from('debts').update({paid_amount: 0}).eq('id', id); loadAll();
            }
        }

        async function loadWallets() {
            const { data } = await _supabase.from('wallets').select('*').order('created_at');
            myWallets = data || [];
            const list = document.getElementById('walletList');
            const sels = [document.getElementById('trxWallet'), document.getElementById('tfFrom'), document.getElementById('tfTo'), document.getElementById('srcWallet'), document.getElementById('srcWalletDebt')];
            list.innerHTML = ''; sels.forEach(s => s.innerHTML = '');
            totalWallet = 0;
            if(myWallets.length === 0) list.innerHTML = '<div class="text-center py-3 small text-muted">Belum ada dompet</div>';
            myWallets.forEach(w => {
                totalWallet += parseFloat(w.balance);
                list.innerHTML += `<div class="wallet-item"><div class="d-flex align-items-center gap-3"><div class="wallet-icon"><i class="fas fa-wallet"></i></div><div><h6 class="fw-bold mb-0" style="font-size:0.9rem">${w.name}</h6><small class="text-muted">${fmt(w.balance)}</small></div></div><div><i class="fas fa-pencil-alt text-muted small me-2 cursor-pointer" onclick="editD(${w.id})"></i><i class="fas fa-trash text-danger small cursor-pointer" onclick="hapusD(${w.id}, '${w.name}')"></i></div></div>`;
                const opt = `<option value="${w.id}">${w.name} (${fmt(w.balance)})</option>`;
                sels.forEach(s => s.innerHTML += opt);
            });
            document.getElementById('walletCount').innerText = myWallets.length + " Akun";
        }

        async function loadTransactions() {
            const list = document.getElementById('transactionList');
            list.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            const monthName = viewDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
            document.getElementById('monthLabel').innerText = monthName;
            document.getElementById('chartLabel').innerText = monthName;
            const startStr = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).toISOString();
            const endStr = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0, 23, 59, 59).toISOString();
            const { data, error } = await _supabase.from('transactions').select('*').eq('user_id', currentUser.id).gte('date', startStr).lte('date', endStr).order('date', {ascending:false});
            if(error) { list.innerHTML = '<div class="text-danger text-center">Gagal memuat</div>'; return; }
            currentTrxData = data || [];
            list.innerHTML = ''; let inc=0, exp=0;
            if(!data || data.length === 0) { list.innerHTML = '<div class="text-center py-5 text-muted small">Belum ada transaksi</div>'; } 
            else {
                data.forEach(t => {
                    if(t.type==='income') inc+=t.amount; else if(t.type==='expense') exp+=t.amount;
                    const wName = myWallets.find(w => w.id == t.wallet_id)?.name || 'Dompet Dihapus';
                    let bg='bg-inc',icon='fa-arrow-down',col='text-success',sign='+';
                    if(t.type==='expense'){bg='bg-exp';icon='fa-arrow-up';col='text-danger';sign='-';}
                    if(t.type==='transfer'){bg='bg-trf';icon='fa-exchange-alt';col='text-dark';sign='';}
                    const displayTitle = t.description ? t.description : t.category;
                    const displaySub = `${t.category} â€¢ ${new Date(t.date).toLocaleDateString()} â€¢ ${wName}`;
                    list.innerHTML += `<div class="trx-item"><div class="d-flex align-items-center"><div class="trx-icon-box ${bg}"><i class="fas ${icon}"></i></div><div><h6 class="fw-bold mb-0 text-dark">${displayTitle}</h6><small class="text-muted" style="font-size:0.8rem">${displaySub}</small></div></div><div class="text-end"><h6 class="fw-bold mb-0 ${col}">${sign} ${fmt(t.amount)}</h6><i class="fas fa-trash text-muted opacity-25 small cursor-pointer" onclick="hapusTrx(${t.id}, ${t.wallet_id}, ${t.amount}, '${t.type}', '${t.description}')"></i></div></div>`;
                });
            }
            renderChart(inc, exp);
        }

        async function downloadPDF() {
            if(currentTrxData.length === 0) return alert("Data kosong mas.");
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            
            let totalMasuk = 0, totalKeluar = 0;
            currentTrxData.forEach(t => { if(t.type==='income') totalMasuk+=t.amount; if(t.type==='expense') totalKeluar+=t.amount; });
            const saldoAwal = totalWallet - totalMasuk + totalKeluar; 

            doc.setFontSize(16); doc.text("LAPORAN KEUANGAN BULANAN", 14, 20);
            doc.setFontSize(10); doc.text(`Periode: ${document.getElementById('monthLabel').innerText}`, 14, 27);
            doc.text(`User: ${currentUser.email}`, 14, 32);

            doc.autoTable({ startY: 40, head: [['RINGKASAN', 'NILAI']], body: [['Saldo Awal (Estimasi)', fmt(saldoAwal)], ['Total Pemasukan', fmt(totalMasuk)], ['Total Pengeluaran', fmt(totalKeluar)], ['SALDO AKHIR (Real)', fmt(totalWallet)]], theme: 'striped', headStyles: {fillColor: [0, 102, 255]} });

            let goalsBody = [];
            if(goalDetails.length > 0) {
                goalDetails.forEach(g => {
                    const fullG = window.myGoals.find(x => x.name === g.name);
                    const target = fullG ? fullG.target_amount : g.amount;
                    const persen = Math.round((g.amount/target)*100) + "%";
                    goalsBody.push([g.name, fmt(target), fmt(g.amount), persen]);
                });
                 doc.text("TARGET TABUNGAN", 14, doc.lastAutoTable.finalY + 10);
                 doc.autoTable({ startY: doc.lastAutoTable.finalY + 15, head: [['Tujuan', 'Target', 'Terkumpul', 'Persen']], body: goalsBody, theme: 'grid', headStyles: {fillColor: [25, 135, 84]} });
            }

            let debtsBody = [];
            debtsData.forEach(d => {
                const sisa = Math.max(0, d.total_amount - d.paid_amount);
                debtsBody.push([d.name, fmt(d.total_amount), fmt(d.paid_amount), fmt(sisa), sisa <= 0 ? "LUNAS" : "BELUM"]);
            });
            doc.text("STATUS CICILAN & HUTANG", 14, doc.lastAutoTable.finalY + 10);
            if(debtsBody.length > 0) { doc.autoTable({ startY: doc.lastAutoTable.finalY + 15, head: [['Nama', 'Total', 'Bayar', 'Sisa', 'Status']], body: debtsBody, theme: 'grid', headStyles: {fillColor: [220, 53, 69]} }); }
            else { doc.text("(Tidak ada data cicilan)", 14, doc.lastAutoTable.finalY + 20); doc.lastAutoTable.finalY += 10; }

            let trxBody = [];
            currentTrxData.forEach(t => {
                const wName = myWallets.find(w => w.id == t.wallet_id)?.name || '-';
                const desc = t.description || t.category;
                const nominal = t.type === 'expense' ? `(${fmt(t.amount)})` : fmt(t.amount);
                trxBody.push([new Date(t.date).toLocaleDateString('id-ID'), t.category, desc, nominal, wName]);
            });
            doc.text("RINCIAN TRANSAKSI", 14, doc.lastAutoTable.finalY + 10);
            doc.autoTable({ startY: doc.lastAutoTable.finalY + 15, head: [['Tanggal', 'Kategori', 'Ket', 'Nominal', 'Dompet']], body: trxBody, theme: 'striped' });

            doc.save(`Laporan_${document.getElementById('monthLabel').innerText}.pdf`);
        }

        function downloadCSV() {
            if(currentTrxData.length === 0) return alert("Data kosong mas.");
            let totalMasuk = 0, totalKeluar = 0;
            currentTrxData.forEach(t => { if(t.type==='income') totalMasuk+=t.amount; if(t.type==='expense') totalKeluar+=t.amount; });
            const saldoAwal = totalWallet - totalMasuk + totalKeluar;

            let csv = `LAPORAN KEUANGAN - ${document.getElementById('monthLabel').innerText}\nUser: ${currentUser.email}\n\n`;
            csv += `RINGKASAN,NILAI\nSaldo Awal,${saldoAwal}\nTotal Masuk,${totalMasuk}\nTotal Keluar,${totalKeluar}\nSaldo Akhir,${totalWallet}\n\n`;
            
            csv += `TARGET TABUNGAN,TARGET,TERKUMPUL,PERSEN\n`;
             if(goalDetails.length > 0) {
                goalDetails.forEach(g => {
                    const fullG = window.myGoals.find(x => x.name === g.name);
                    const target = fullG ? fullG.target_amount : g.amount;
                    const persen = Math.round((g.amount/target)*100) + "%";
                    csv += `${g.name},${target},${g.amount},${persen}\n`;
                });
            } else { csv += `(Tidak ada target),,,\n`; }
            csv += `\n`;

            csv += `CICILAN,TOTAL,BAYAR,SISA,STATUS\n`;
            debtsData.forEach(d => {
                const sisa = Math.max(0, d.total_amount - d.paid_amount);
                csv += `${d.name},${d.total_amount},${d.paid_amount},${sisa},${sisa<=0?'LUNAS':'BELUM'}\n`;
            });
            csv += `\n`;

            csv += `TANGGAL,TIPE,KATEGORI,KETERANGAN,MASUK,KELUAR,DOMPET\n`;
            currentTrxData.forEach(row => {
                const date = new Date(row.date).toLocaleDateString('id-ID');
                const wName = myWallets.find(w => w.id == row.wallet_id)?.name || 'X';
                const desc = (row.description || '').replace(/,/g, ' '); 
                const uMasuk = row.type === 'income' ? row.amount : 0;
                const uKeluar = row.type === 'expense' ? row.amount : 0;
                csv += `${date},${row.type},${row.category},"${desc}",${uMasuk},${uKeluar},"${wName}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.hidden = true; a.href = url; a.download = `Laporan_${document.getElementById('monthLabel').innerText}.csv`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // --- UPDATE 2: FITUR TOTAL DI TARGET ---
        async function loadGoals() {
            const { data: goals } = await _supabase.from('goals').select('*').order('created_at');
            const list = document.getElementById('goalList'); list.innerHTML = '';
            totalGoal = 0; goalDetails = []; window.myGoals = goals || [];
            
            let sumTarget = 0;
            let sumCollected = 0;

            if(goals && goals.length > 0) {
                for(let g of goals) {
                    const { data: trxs } = await _supabase.from('transactions').select('amount').eq('goal_id', g.id);
                    let cur = 0; if(trxs) trxs.forEach(t => cur += t.amount);
                    totalGoal += cur;
                    if(cur > 0) goalDetails.push({ name: g.name, amount: cur });
                    const pct = Math.min(100, Math.round((cur/g.target_amount)*100));
                    
                    sumTarget += g.target_amount;
                    sumCollected += cur;

                    list.innerHTML += `<div class="mb-3 border-bottom pb-2"><div class="d-flex justify-content-between align-items-center mb-1"><span class="small fw-bold">${g.name} <span class="text-primary">${pct}%</span></span><div><i class="fas fa-pencil-alt text-muted small me-2 cursor-pointer" onclick="editGoal(${g.id})"></i><i class="fas fa-trash text-danger small cursor-pointer" onclick="hapusGoal(${g.id}, '${g.name}')"></i></div></div><div class="progress mb-2"><div class="progress-bar bg-primary" style="width:${pct}%"></div></div><div class="d-flex justify-content-between align-items-center"><small class="text-muted">${fmt(cur)} / ${fmt(g.target_amount)}</small><button class="btn btn-sm btn-light text-primary py-0" onclick="modalNabung(${g.id},'${g.name}')">+ Isi</button></div></div>`;
                }

                // TAMBAHAN: TOTAL DI BAWAH
                list.innerHTML += `
                <div class="mt-2 pt-2 border-top d-flex justify-content-between fw-bold" style="font-size: 0.8rem;">
                    <span>Target: ${fmt(sumTarget)}</span>
                    <span class="text-primary">Terkumpul: ${fmt(sumCollected)}</span>
                </div>`;

            } else { list.innerHTML = '<div class="text-center text-muted small py-2">Belum ada target</div>'; }
        }

        function changeMonth(offset) { viewDate.setMonth(viewDate.getMonth() + offset); loadTransactions(); }
        
        async function simpanDebt() { 
            const id = document.getElementById('editDId').value;
            const n = document.getElementById('dName').value; const t = document.getElementById('dTotal').value; 
            if(!n || !t) return alert("Lengkapi data!"); 
            if(id) { await _supabase.from('debts').update({name:n, total_amount:t}).eq('id', id); } 
            else { await _supabase.from('debts').insert({user_id:currentUser.id, name:n, total_amount:t, paid_amount:0}); }
            bukaModal('modalDebt', false); document.getElementById('editDId').value=''; document.getElementById('dName').value=''; document.getElementById('dTotal').value=''; loadAll(); 
        }
        
        async function prosesBayarCicilan() { 
            const dId = document.getElementById('debtIdHide').value; const wId = document.getElementById('srcWalletDebt').value; const amt = parseFloat(document.getElementById('payDebtAmount').value); 
            const wa = myWallets.find(w => w.id == wId); if(wa.balance < amt) return alert("Saldo dompet kurang!"); 
            const { data: dData } = await _supabase.from('debts').select('*').eq('id', dId).single(); const newPaid = parseFloat(dData.paid_amount) + amt; 
            await _supabase.from('wallets').update({balance: parseFloat(wa.balance) - amt}).eq('id', wId); 
            await _supabase.from('debts').update({paid_amount: newPaid}).eq('id', dId); 
            await _supabase.from('transactions').insert({ user_id: currentUser.id, wallet_id: wId, type: 'expense', amount: amt, category: 'Cicilan', description: 'Bayar ' + dData.name, date: new Date().toISOString() }); 
            bukaModal('modalBayarCicilan', false); document.getElementById('payDebtAmount').value=''; loadAll(); 
        }

        async function hapusDebt(id, name) { if(confirm(`Hapus data cicilan "${name}"?`)) { await _supabase.from('debts').delete().eq('id', id); loadAll(); } }
        function modalBayarCicilan(id, n) { document.getElementById('debtIdHide').value=id; document.getElementById('lblDebtName').innerText=n; bukaModal('modalBayarCicilan'); }
        function fmt(n) { return new Intl.NumberFormat('id-ID', {style:'currency',currency:'IDR', minimumFractionDigits:0}).format(n); }
        function bukaModal(id, s=true) { const m=bootstrap.Modal.getOrCreateInstance(document.getElementById(id)); s?m.show():m.hide(); }
        function modeTrx(t) { document.getElementById(t==='income'?'inc':'exp').checked=true; updateCat(); bukaModal('modalTransaksi'); }
        function modalNabung(id, n) { document.getElementById('targetIdHide').value=id; document.getElementById('lblTargetName').innerText=n; bukaModal('modalNabung'); }
        function updateCat() { const t = document.querySelector('input[name="trxType"]:checked').value; const s = document.getElementById('trxCategory'); s.innerHTML=''; const o = t==='income'?['Gaji','Bonus','Lainnya']:['Makan','Jajan','Transport','Tagihan','Cicilan','Lainnya']; o.forEach(v=>s.innerHTML+=`<option>${v}</option>`); document.getElementById('lblInc').className=t==='income'?'btn btn-success w-50':'btn btn-outline-success w-50'; document.getElementById('lblExp').className=t==='expense'?'btn btn-danger w-50':'btn btn-outline-danger w-50'; }
        function renderChart(i, e) { const ctx = document.getElementById('chartArusKas').getContext('2d'); if(window.myChart) window.myChart.destroy(); window.myChart = new Chart(ctx, { type: 'bar', data: { labels: ['Pemasukan','Pengeluaran'], datasets: [{label:'Total',data:[i,e],backgroundColor:['#16A34A','#DC2626'],borderRadius:10}] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } }); }
        
        async function hapusTrx(id, wid, amt, type, desc) { 
            if(!confirm("Hapus transaksi ini? Saldo akan dikembalikan.")) return; 
            await _supabase.from('transactions').delete().eq('id',id); 
            const w=myWallets.find(x=>x.id==wid); 
            if(w && type!=='transfer'){ const nb=type==='income'?parseFloat(w.balance)-amt:parseFloat(w.balance)+amt; await _supabase.from('wallets').update({balance:nb}).eq('id',wid); }
            if (desc && desc.startsWith('Bayar ')) { const debtName = desc.replace('Bayar ', '').trim(); const { data: debts } = await _supabase.from('debts').select('*').eq('name', debtName).single(); if (debts) { const newPaid = Math.max(0, debts.paid_amount - amt); await _supabase.from('debts').update({paid_amount: newPaid}).eq('id', debts.id); } }
            loadAll(); 
        }

        async function hapusD(id, n) { if(confirm("Hapus "+n+"?")) { await _supabase.from('transactions').delete().eq('wallet_id',id); await _supabase.from('wallets').delete().eq('id',id); loadAll(); } }
        function editD(id) { const w = myWallets.find(x=>x.id==id); document.getElementById('editWId').value=w.id; document.getElementById('wName').value=w.name; document.getElementById('wBalance').value=w.balance; bukaModal('modalAddWallet'); }
        async function simpanDompet() { const id=document.getElementById('editWId').value, n=document.getElementById('wName').value, b=document.getElementById('wBalance').value; if(id) await _supabase.from('wallets').update({name:n,balance:b}).eq('id',id); else await _supabase.from('wallets').insert({user_id:currentUser.id,name:n,balance:b||0}); bukaModal('modalAddWallet',false); document.getElementById('editWId').value=''; loadAll(); }
        function editGoal(id) { const g = window.myGoals.find(item => item.id == id); if(g) { document.getElementById('editGId').value = g.id; document.getElementById('gName').value = g.name; document.getElementById('gTarget').value = g.target_amount; bukaModal('modalGoal'); } }
        async function hapusGoal(id, name) { if(confirm(`Hapus target "${name}"?`)) { await _supabase.from('goals').delete().eq('id', id); loadAll(); } }
        async function simpanGoal() { const id=document.getElementById('editGId').value,n=document.getElementById('gName').value,t=document.getElementById('gTarget').value; if(id) await _supabase.from('goals').update({name:n,target_amount:t}).eq('id',id); else await _supabase.from('goals').insert({user_id:currentUser.id,name:n,target_amount:t}); bukaModal('modalGoal',false); document.getElementById('editGId').value='';document.getElementById('gName').value='';document.getElementById('gTarget').value='';loadAll(); }
        async function simpanTransaksi() { const t=document.querySelector('input[name="trxType"]:checked').value, w=document.getElementById('trxWallet').value, a=parseFloat(document.getElementById('trxAmount').value), c=document.getElementById('trxCategory').value, d=document.getElementById('trxDesc').value; if(!a) return alert("Nominal?"); await _supabase.from('transactions').insert({user_id:currentUser.id, wallet_id:w, type:t, amount:a, category:c, description:d, date:new Date().toISOString()}); const wa=myWallets.find(x=>x.id==w); const nb=t==='income'?parseFloat(wa.balance)+a:parseFloat(wa.balance)-a; await _supabase.from('wallets').update({balance:nb}).eq('id',w); bukaModal('modalTransaksi',false); document.getElementById('trxAmount').value=''; loadAll(); }
        async function simpanTransfer() { const f=document.getElementById('tfFrom').value, t=document.getElementById('tfTo').value, a=parseFloat(document.getElementById('tfAmt').value); if(f==t||!a) return alert("Cek data!"); const wf=myWallets.find(x=>x.id==f), wt=myWallets.find(x=>x.id==t); if(wf.balance<a) return alert("Saldo kurang!"); await _supabase.from('wallets').update({balance:parseFloat(wf.balance)-a}).eq('id',f); await _supabase.from('wallets').update({balance:parseFloat(wt.balance)+a}).eq('id',t); await _supabase.from('transactions').insert({user_id:currentUser.id, wallet_id:f, type:'transfer', amount:a, category:'Transfer', description:'Ke '+wt.name, date:new Date().toISOString()}); bukaModal('modalTransfer',false); document.getElementById('tfAmt').value=''; loadAll(); }
        async function prosesNabung() { const g=document.getElementById('targetIdHide').value, w=document.getElementById('srcWallet').value, a=parseFloat(document.getElementById('saveAmount').value); const wa=myWallets.find(x=>x.id==w); if(wa.balance<a) return alert("Saldo kurang!"); await _supabase.from('wallets').update({balance:parseFloat(wa.balance)-a}).eq('id',w); await _supabase.from('transactions').insert({user_id:currentUser.id, wallet_id:w, type:'expense', amount:a, category:'Tabungan', description:'Nabung Target', goal_id:g, date:new Date().toISOString()}); bukaModal('modalNabung',false); document.getElementById('saveAmount').value=''; loadAll(); }
        
        document.getElementById('btnLogout').addEventListener('click', async () => { await _supabase.auth.signOut(); localStorage.clear(); window.location.href = 'index.html?logout=true'; });
    </script>
</body>
</html>
